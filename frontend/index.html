<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat App</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="app">
    <header class="header">
      ðŸ’¬ Chat App
    </header>

    <div class="chat-area" id="chatBox"></div>

    <div class="input-area">
      <input type="text" id="name" placeholder="Name" class="name-input" />
      <input type="text" id="message" placeholder="Type a message..." class="msg-input" />
      <button onclick="sendMessage()">âž¤</button>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://chat-backend-l2uy.onrender.com';
    let lastUser = "";

    async function sendMessage() {
      const name = document.getElementById("name").value.trim();
      const message = document.getElementById("message").value.trim();

      if (!name || !message) return;

      try {
        await fetch(`${BACKEND_URL}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: name, message: message })
        });

        document.getElementById("message").value = "";
        fetchMessages();
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }

    async function fetchMessages() {
      try {
        const response = await fetch(`${BACKEND_URL}/messages`);
        const messages = await response.json();
        const chatBox = document.getElementById("chatBox");
        
        chatBox.innerHTML = '';
        
        messages.forEach((msg, index) => {
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("msg");
          
          const prevUser = index > 0 ? messages[index - 1].user : null;
          msgDiv.classList.add(msg.user === prevUser ? "right" : "left");

          const avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.user}`;
          
          msgDiv.innerHTML = `
            <img src="${avatar}" alt="${msg.user}" class="avatar">
            <div class="bubble">
              <span class="user">${msg.user}</span>
              <p>${msg.message}</p>
              <span class="time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
            </div>
          `;

          chatBox.appendChild(msgDiv);
        });
        
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (error) {
        console.error('Error fetching messages:', error);
      }
    }

    // Enter key to send
    document.getElementById("message")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // Fetch messages every second
    setInterval(fetchMessages, 1000);
    fetchMessages();
  </script>

</body>
</html>
